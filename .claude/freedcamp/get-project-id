#!/usr/bin/env python3
"""
Get Freedcamp Project ID - Helper to find your project ID

Usage:
    ./get-project-id
"""

import json
import hashlib
import hmac
import time
import urllib.request
from pathlib import Path

CREDENTIALS_FILE = Path.home() / '.config' / 'freedcamp' / 'credentials.json'

def load_credentials():
    with open(CREDENTIALS_FILE) as f:
        return json.load(f)

def make_auth_params(api_key, api_secret):
    timestamp = str(int(time.time()))
    message = api_key + timestamp
    hash_value = hmac.new(api_secret.encode(), message.encode(), hashlib.sha1).hexdigest()
    return {
        'api_key': api_key,
        'timestamp': timestamp,
        'hash': hash_value
    }

def get_projects():
    creds = load_credentials()
    auth = make_auth_params(creds['api_key'], creds['api_secret'])

    # Build URL with auth params
    params = '&'.join([f"{k}={v}" for k, v in auth.items()])
    url = f"https://freedcamp.com/api/v1/projects?{params}"

    try:
        with urllib.request.urlopen(url) as response:
            data = json.loads(response.read().decode())
            return data.get('data', {}).get('projects', [])
    except Exception as e:
        print(f"‚ùå Error fetching projects: {e}")
        return []

def main():
    print("\nüîç Fetching your Freedcamp projects...\n")
    print("="*80)

    projects = get_projects()

    if not projects:
        print("‚ùå No projects found or API error")
        return

    for project in projects:
        project_id = project.get('id')
        project_name = project.get('title', 'Unnamed')
        status = project.get('status', 'unknown')

        print(f"\nüìÅ {project_name}")
        print(f"   ID: {project_id}")
        print(f"   Status: {status}")
        print("-"*80)

    print(f"\n‚úÖ Found {len(projects)} project(s)")
    print("\nTo use a project ID, update config.json:")
    print('  {"project_id": "YOUR_PROJECT_ID", "project_name": "Project Name"}')
    print()

if __name__ == '__main__':
    main()
