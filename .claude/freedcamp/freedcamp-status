#!/usr/bin/env python3
"""
Freedcamp Status Checker - Check testing progress and comments

Usage:
    freedcamp-status              # Show all tasks status
    freedcamp-status --comments   # Show tasks with comments
    freedcamp-status --bugs       # Show bug reports
    freedcamp-status --completed  # Show completed tasks only
"""

import json
import hashlib
import hmac
import time
import urllib.request
import argparse
from pathlib import Path

# Project-specific config for jahongir-travel-staging
SCRIPT_DIR = Path(__file__).parent
CREDENTIALS_FILE = Path.home() / '.config' / 'freedcamp' / 'credentials.json'
CONFIG_FILE = SCRIPT_DIR / 'config.json'

def load_config():
    with open(CREDENTIALS_FILE) as f:
        creds = json.load(f)
    with open(CONFIG_FILE) as f:
        config = json.load(f)
    return creds, config

def make_auth(creds):
    timestamp = str(int(time.time()))
    message = creds['api_key'] + timestamp
    hash_value = hmac.new(creds['api_secret'].encode(), message.encode(), hashlib.sha1).hexdigest()
    return f"api_key={creds['api_key']}&timestamp={timestamp}&hash={hash_value}"

def get_tasks():
    creds, config = load_config()
    auth = make_auth(creds)
    url = f"https://freedcamp.com/api/v1/tasks?project_id={config['project_id']}&{auth}"

    with urllib.request.urlopen(url) as response:
        return json.loads(response.read().decode())['data']['tasks']

def get_comments(task_id):
    creds, config = load_config()
    auth = make_auth(creds)
    url = f"https://freedcamp.com/api/v1/comments?item_id={task_id}&item_type=tasks&{auth}"

    try:
        with urllib.request.urlopen(url) as response:
            return json.loads(response.read().decode())['data'].get('comments', [])
    except:
        return []

def show_status():
    tasks = get_tasks()

    completed = [t for t in tasks if t.get('status') == 1]
    open_tasks = [t for t in tasks if t.get('status') != 1]

    print("\n" + "="*60)
    print("ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¢Ğ•Ğ¡Ğ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯")
    print("="*60)

    # Progress bar
    total = len(tasks)
    done = len(completed)
    pct = int(done/total*100) if total > 0 else 0
    bar = 'â–ˆ' * (pct // 5) + 'â–‘' * (20 - pct // 5)
    print(f"\n[{bar}] {pct}% ({done}/{total})")

    # Open tasks by priority
    print("\nğŸ“‹ ĞĞ¢ĞšĞ Ğ«Ğ¢Ğ«Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜:")
    priority_names = {3: 'ğŸ”´ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹', 2: 'ğŸŸ¡ Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹', 1: 'ğŸ”µ ĞĞ¸Ğ·ĞºĞ¸Ğ¹', 0: 'âšª ĞĞµÑ‚'}

    for p in [3, 2, 1, 0]:
        p_tasks = [t for t in open_tasks if int(t.get('priority', 0)) == p]
        if p_tasks:
            print(f"\n  {priority_names[p]}:")
            for t in p_tasks:
                print(f"    â¬œ {t['title'][:45]}")

    # Completed
    if completed:
        print(f"\nâœ… Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ ({len(completed)}):")
        for t in completed:
            print(f"    âœ… {t['title'][:45]}")

    print("\n" + "="*60)

def show_with_comments():
    tasks = get_tasks()

    print("\n" + "="*60)
    print("ğŸ’¬ Ğ—ĞĞ”ĞĞ§Ğ˜ Ğ¡ ĞšĞĞœĞœĞ•ĞĞ¢ĞĞ Ğ˜Ğ¯ĞœĞ˜")
    print("="*60)

    found = False
    for task in tasks:
        comments = get_comments(task['id'])
        if comments:
            found = True
            status = 'âœ…' if task.get('status') == 1 else 'â¬œ'
            print(f"\n{status} {task['title']}")
            print("-" * 40)
            for c in comments[-3:]:  # Last 3 comments
                author = c.get('user_name', 'Unknown')
                text = c.get('description', '')[:200]
                print(f"  ğŸ’¬ {author}: {text}")

    if not found:
        print("\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² Ğº Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼.")

    print("\n" + "="*60)

def show_bugs():
    tasks = get_tasks()

    print("\n" + "="*60)
    print("ğŸ› ĞĞĞ™Ğ”Ğ•ĞĞĞ«Ğ• Ğ‘ĞĞ“Ğ˜")
    print("="*60)

    found = False
    for task in tasks:
        comments = get_comments(task['id'])
        for c in comments:
            text = c.get('description', '')
            if 'ğŸ›' in text or 'Ğ‘ĞĞ“' in text.upper() or 'BUG' in text.upper() or 'âŒ' in text:
                found = True
                print(f"\nğŸ“ Ğ’ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğµ: {task['title'][:40]}")
                print(f"   {text[:300]}")
                print("-" * 40)

    # Also check for bug tasks
    bug_tasks = [t for t in tasks if 'ğŸ›' in t['title'] or 'Ğ‘ĞĞ“' in t['title'].upper()]
    for t in bug_tasks:
        found = True
        status = 'âœ…' if t.get('status') == 1 else 'â¬œ'
        print(f"\n{status} {t['title']}")

    if not found:
        print("\nâœ¨ Ğ‘Ğ°Ğ³Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!")

    print("\n" + "="*60)

def show_completed():
    tasks = get_tasks()
    completed = [t for t in tasks if t.get('status') == 1]

    print("\n" + "="*60)
    print("âœ… Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞĞ«Ğ• Ğ—ĞĞ”ĞĞ§Ğ˜")
    print("="*60)

    if not completed:
        print("\nĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡.")
    else:
        for t in completed:
            print(f"\nâœ… {t['title']}")
            comments = get_comments(t['id'])
            if comments:
                last = comments[-1]
                print(f"   Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: {last.get('description', '')[:150]}")

    print("\n" + "="*60)

def main():
    parser = argparse.ArgumentParser(description='Check Freedcamp testing status')
    parser.add_argument('--comments', action='store_true', help='Show tasks with comments')
    parser.add_argument('--bugs', action='store_true', help='Show bug reports')
    parser.add_argument('--completed', action='store_true', help='Show completed tasks')

    args = parser.parse_args()

    if args.comments:
        show_with_comments()
    elif args.bugs:
        show_bugs()
    elif args.completed:
        show_completed()
    else:
        show_status()

if __name__ == '__main__':
    main()
